<!DOCTYPE html>
<html ng-app="app">
<head>
  <link href="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.min.css" rel="stylesheet">
  <link href="css/app.css" rel="stylesheet">
</head>
<body>
<div class="navbar navbar-inverse" role="navigation">
  <div class="container-fluid">
    <div class="navbar-header">
      <a class="navbar-brand" href="#">
        <img src="css/images/logo.png">
        Asgard
      </a>
    </div>
  </div>
</div>
<div class="navbar" id="globalnav" role="global">
  <div class="container-fluid">
    <ul class="nav navbar-nav">
      <li><a href="#" id="app-nav">Apps</a></li>
      <li><a href="#" id="cluster-nav">Clusters</a></li>
    </ul>
  </div>
</div>
<div class="container-fluid">
  <div class="row">
    <div class="col-md-12" ng-view=""></div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.6.0/moment.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
<script src="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.15/angular.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.15/angular-route.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.15/angular-resource.min.js"></script>

<script>
  var app = angular.module("app", ["ngRoute", "ngResource"]);
  app.config(['$routeProvider', function($routeProvider) {
    $routeProvider.when('/', {
      templateUrl: 'partials/landing.html',
      controller: LandingPageController
    }).when('/:deployable/clusters/:cluster?/:region?', {
      templateUrl: 'partials/clusters.html',
      controller: ClusterController
    }).when('/:deployable/clusters/:cluster/asgs/:asg/:region', {
      templateUrl: 'partials/asg.html',
      controller: AsgController
    })
    .otherwise('/')
  }]);

  function LandingPageController($scope, $location, $resource, $timeout) {
    var DeployableResource = $resource("/deployables");

    (function tick() {
      var deployables = DeployableResource.get(function () {
        $scope.deployables = deployables;
        $timeout(tick, 30000);
      });
    })();

    $scope.go = function(deployable) {
      $location.path('/'+deployable+'/clusters');
    };

    $scope.splitTags = function(tags) {
      if (tags) {
        return tags.split(",");
      } else {
        return [];
      }
    };

    $scope.toAgo = function(input) {
      if (!input) {
        return "";
      }
      return moment(parseInt(input)).fromNow();
    };
  }

  function NewDeploymentController($scope, $resource) {
    var KatoResource = $resource("http://localhost:8501/ops");

    $scope.regions = [];
    $scope.deploy = function() {
      console.log($scope.regions);
    };

    var PricingResource = $resource("/pricing/:type");
    var prices = PricingResource.get(function() {
      $scope.prices = prices;
    });

    $scope.getAvailableTypes = function() {
      var availableTypes = [];

      for (name in $scope.prices) {
        var type = $scope.prices[name];
        var available = true;
        for (var i=0;i<$scope.chosenImages.length;i++) {
          var image = $scope.chosenImages[i];
          if (!type.hasOwnProperty(image.region)) {
            available = false;
            break;
          }
        }
        if (available) {
          availableTypes.push(name);
        }
      }
      $scope.availableTypes = availableTypes;
      console.log(availableTypes);
    };

    var ImageResource = $resource("/deployables/:pkg/images");
    $scope.updateImages = function() {
      var images = ImageResource.query({pkg: $scope.pkg}, function() {
        $scope.images = images;
      });
    };

    $scope.chosenImages = [];

    $scope.deploy = function() {
      var basicDeployments = [];
      for (var i=0;i<$scope.chosenImages.length;i++) {
        var image = $scope.chosenImages[i];
        var azs = {};
        azs[image.region] = [image.region+"a"];
        var description = { application: $scope.deployable, amiName: image.name,
          stack: $scope.stack, instanceType: $scope.instanceType, securityGroups: ["nf-datacenter", "nf-infrastructure"],
          availabilityZones: azs, credentials: "test" };
        if ($scope.copyLastAsg) {
          basicDeployments.push({ copyLastAsgDescription: description });
        } else {
          description.capacity = { min: parseInt($scope.minInstances), max: parseInt($scope.maxInstances),
            desired: parseInt($scope.desiredInstances) };
          basicDeployments.push({ basicAmazonDeployDescription: description });
        }
      }
      KatoResource.save(basicDeployments, function() {
        $("#newDeploymentModal").modal("hide");
      });
    }
  }

  function ClusterController($scope, $routeParams, $resource, $timeout) {
    var ClusterResource = $resource("/deployables/:deployable/clusters/:cluster");
    $scope.deployable = $routeParams.deployable;
    $scope.cluster = $routeParams.cluster;

    if ($routeParams.cluster) {
      $scope.cluster = $routeParams.cluster;
    }

    if ($routeParams.region) {
      $scope.region = $routeParams.region;
    }

    (function tick() {
      var asgs = ClusterResource.query({deployable: $routeParams.deployable, cluster: $routeParams.cluster, region: $routeParams.region}, function () {
        $scope.asgs = asgs;
        $timeout(tick, 10000);
      });
    })();

    $scope.toAgo = function(input) {
      if (!input) {
        return "";
      }
      return moment(parseInt(input)).fromNow();
    };

    $scope.regions = [];
    $scope.createAsg = function() {
      console.log($scope.regions);
    };

    var KatoResource = $resource("http://localhost:8501/ops");
    $scope.shrink = function() {
      var regions = [];
      for (var i=0;i<$scope.asgs.length;i++) {
        var asg = $scope.asgs[i];
        regions.push(asg.region);
      }
      var description = { shrinkClusterDescription: { application: $scope.deployable, clusterName: $scope.cluster, regions: regions, credentials: "test" }};
      KatoResource.save([description], function() {
        $("#shrinkClusterModal").modal("hide");
      });
    }
  }

  function AsgController($scope, $routeParams, $resource, $location, $timeout) {
    var KatoResource = $resource("http://localhost:8501/ops");

    var AsgResource = $resource("/deployables/:deployable/clusters/:cluster/asgs/:asg/:region");
    $scope.deployable = $routeParams.deployable;
    $scope.cluster = $routeParams.cluster;
    $scope.region = $routeParams.region;

    (function tick() {
      var asg = AsgResource.get({deployable: $routeParams.deployable, cluster: $routeParams.cluster, asg: $routeParams.asg, region: $routeParams.region}, function() {
        $scope.asg = asg;
        $timeout(tick, 10000);
      });
    })();

    $scope.toAgo = function(input) {
      if (!input) {
        return "";
      }
      return moment(parseInt(input)).fromNow();
    };

    $scope.resize = function(asg, region) {
      var description = { resizeAsgDescription: { asgName: asg, regions: [region],
        capacity: { min: parseInt($scope.resizeMin), max: parseInt($scope.resizeMax), desired: parseInt($scope.resizeDesired) },
        credentials: "test" }};
      KatoResource.save([description], function() {
        $("#resizeModal").modal("hide");
      });
    };

    $scope.doAsgDelete = function(asg, region) {
      var description = { deleteAsgDescription: { asgName: asg, region: region, credentials: "test" }};
      KatoResource.save([description], function() {
        $("#deleteModal").modal("hide", function() {
          $location.path("/" + $scope.deployable + "/clusters");
        });
      });
    };

    $scope.showUserData = function() {
      var newWindow = window.open();
      var pre = newWindow.document.createElement("pre");
      pre.innerHTML = $scope.asg.userData;
      newWindow.document.body.appendChild(pre);
    }
  }

</script>
</body>
</html>